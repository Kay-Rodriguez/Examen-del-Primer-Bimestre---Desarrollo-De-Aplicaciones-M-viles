{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/KarlaR/Downloads/movistarexamen_project/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { createClient } from '@supabase/supabase-js';\nimport * as i0 from \"@angular/core\";\nexport let SupabaseService = /*#__PURE__*/(() => {\n  class SupabaseService {\n    constructor() {\n      this.supabase = createClient('https://jgspryrvyhfkiauidfoo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impnc3ByeXJ2eWhma2lhdWlkZm9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTI5MTAsImV4cCI6MjA3ODk2ODkxMH0.b5dFwDxJ7tJLd_xWPtrMcTd1zhCNoBWN6spXBzWa2mQ');\n    }\n    // ============================================================\n    // ðŸ” AUTENTICACIÃ“N\n    // ============================================================\n    signUp(nombre, email, pass, telefono) {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        // 1ï¸âƒ£ Crear usuario en auth\n        const {\n          data,\n          error\n        } = yield _this.supabase.auth.signUp({\n          email,\n          password: pass\n        });\n        if (error) throw error;\n        const userId = data.user?.id;\n        if (!userId) throw new Error('No se pudo obtener el ID del usuario');\n        // 2ï¸âƒ£ Esperar a que el trigger cree el perfil automÃ¡tico\n        // (sin esto a veces el perfil no existe todavÃ­a)\n        yield new Promise(res => setTimeout(res, 500));\n        // 3ï¸âƒ£ Actualizar el perfil creado por el trigger\n        const {\n          error: perfilError\n        } = yield _this.supabase.from('perfiles').update({\n          nombre_completo: nombre,\n          telefono: telefono\n        }).eq('id', userId);\n        if (perfilError) throw perfilError;\n        return data;\n      })();\n    }\n    signIn(email, pass) {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data,\n          error\n        } = yield _this2.supabase.auth.signInWithPassword({\n          email,\n          password: pass\n        });\n        if (error) throw error;\n        return data;\n      })();\n    }\n    getPerfilActual() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data: {\n            user\n          }\n        } = yield _this3.supabase.auth.getUser();\n        if (!user) return null;\n        const {\n          data\n        } = yield _this3.supabase.from('perfiles').select('*').eq('id', user.id).single();\n        return data;\n      })();\n    }\n    logout() {\n      return this.supabase.auth.signOut();\n    }\n    // ============================================================\n    // ðŸ“¦ PLANES MÃ“VILES\n    // ============================================================\n    // pÃºblico / usuario\n    getPlanesPublicos() {\n      var _this4 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data,\n          error\n        } = yield _this4.supabase.from('planes_moviles').select('*').eq('activo', true).order('id', {\n          ascending: true\n        });\n        if (error) throw error;\n        return data;\n      })();\n    }\n    // asesor â€“ todos los planes (activos/inactivos)\n    getPlanesAsesor() {\n      var _this5 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data,\n          error\n        } = yield _this5.supabase.from('planes_moviles').select('*').order('created_at', {\n          ascending: false\n        });\n        if (error) throw error;\n        return data;\n      })();\n    }\n    // subir imagen a bucket planes-imagenes y devolver URL pÃºblica\n    subirImagenPlan(file) {\n      var _this6 = this;\n      return _asyncToGenerator(function* () {\n        if (!file) return null;\n        const filePath = `plan-${Date.now()}-${file.name}`;\n        const {\n          error\n        } = yield _this6.supabase.storage.from('planes-imagenes').upload(filePath, file, {\n          upsert: true\n        });\n        if (error) throw error;\n        const {\n          data\n        } = _this6.supabase.storage.from('planes-imagenes').getPublicUrl(filePath);\n        return data.publicUrl;\n      })();\n    }\n    crearPlan(plan, file) {\n      var _this7 = this;\n      return _asyncToGenerator(function* () {\n        let imagen_url = plan.imagen_url ?? null;\n        if (file) {\n          imagen_url = yield _this7.subirImagenPlan(file);\n        }\n        const payload = {\n          ...plan,\n          imagen_url\n        };\n        const {\n          error\n        } = yield _this7.supabase.from('planes_moviles').insert(payload);\n        if (error) throw error;\n      })();\n    }\n    editarPlan(id, plan, file, imagenAnterior) {\n      var _this8 = this;\n      return _asyncToGenerator(function* () {\n        let imagen_url = plan.imagen_url ?? imagenAnterior ?? null;\n        if (file) {\n          imagen_url = yield _this8.subirImagenPlan(file);\n          // (Opcional) podrÃ­as borrar la imagen anterior aquÃ­\n        }\n        const payload = {\n          ...plan,\n          imagen_url\n        };\n        const {\n          error\n        } = yield _this8.supabase.from('planes_moviles').update(payload).eq('id', id);\n        if (error) throw error;\n      })();\n    }\n    eliminarPlan(id) {\n      var _this9 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          error\n        } = yield _this9.supabase.from('planes_moviles').delete().eq('id', id);\n        if (error) throw error;\n      })();\n    }\n    // ============================================================\n    // ðŸ§¾ CONTRATACIONES\n    // ============================================================\n    contratarPlan(planId) {\n      var _this0 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data: {\n            user\n          }\n        } = yield _this0.supabase.auth.getUser();\n        const {\n          error\n        } = yield _this0.supabase.from('contrataciones').insert({\n          usuario_id: user?.id,\n          plan_id: planId\n        });\n        if (error) throw error;\n      })();\n    }\n    misContratos() {\n      var _this1 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data: {\n            user\n          }\n        } = yield _this1.supabase.auth.getUser();\n        const {\n          data,\n          error\n        } = yield _this1.supabase.from('contrataciones').select('*, planes_moviles(*)').eq('usuario_id', user?.id).order('created_at', {\n          ascending: false\n        });\n        if (error) throw error;\n        return data;\n      })();\n    }\n    // ðŸ”¹ Lista para el asesor (todas)\n    asesorSolicitudes() {\n      var _this10 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data,\n          error\n        } = yield _this10.supabase.from('contrataciones').select(`\n        id,\n        estado,\n        created_at,\n        planes_moviles ( id, nombre, precio_mensual ),\n        perfiles!contrataciones_usuario_id_fkey ( nombre_completo )\n      `).order('created_at', {\n          ascending: false\n        });\n        if (error) throw error;\n        return data;\n      })();\n    }\n    cambiarEstado(id, estado) {\n      var _this11 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          error\n        } = yield _this11.supabase.from('contrataciones').update({\n          estado\n        }).eq('id', id);\n        if (error) throw error;\n      })();\n    }\n    // ============================================================\n    // ðŸ’¬ CHAT\n    // ============================================================\n    mensajesPorContratacion(contratacionId) {\n      var _this12 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data,\n          error\n        } = yield _this12.supabase.from('mensajes_chat').select('*').eq('contratacion_id', contratacionId).order('created_at', {\n          ascending: true\n        });\n        if (error) throw error;\n        return data;\n      })();\n    }\n    enviarMensaje(contratacionId, texto) {\n      var _this13 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          data: {\n            user\n          }\n        } = yield _this13.supabase.auth.getUser();\n        const {\n          error\n        } = yield _this13.supabase.from('mensajes_chat').insert({\n          contratacion_id: contratacionId,\n          mensaje: texto,\n          emisor_id: user?.id\n        });\n        if (error) throw error;\n      })();\n    }\n    escucharChat(contratacionId, callback) {\n      return this.supabase.channel('chat_room_' + contratacionId).on('postgres_changes', {\n        event: 'INSERT',\n        schema: 'public',\n        table: 'mensajes_chat',\n        filter: `contratacion_id=eq.${contratacionId}`\n      }, payload => callback(payload.new)).subscribe();\n    }\n    static {\n      this.Éµfac = function SupabaseService_Factory(t) {\n        return new (t || SupabaseService)();\n      };\n    }\n    static {\n      this.Éµprov = /*@__PURE__*/i0.ÉµÉµdefineInjectable({\n        token: SupabaseService,\n        factory: SupabaseService.Éµfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return SupabaseService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}