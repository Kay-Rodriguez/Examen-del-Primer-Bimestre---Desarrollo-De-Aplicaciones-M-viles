{"ast":null,"code":"// This file draws heavily from https://github.com/phoenixframework/phoenix/commit/cf098e9cf7a44ee6479d31d911a97d3c7430c6fe\n// License: https://github.com/phoenixframework/phoenix/blob/master/LICENSE.md\nimport { CHANNEL_EVENTS } from '../lib/constants';\nclass Serializer {\n  constructor() {\n    this.HEADER_LENGTH = 1;\n    this.META_LENGTH = 4;\n    this.USER_BROADCAST_PUSH_META_LENGTH = 5;\n    this.KINDS = {\n      push: 0,\n      reply: 1,\n      broadcast: 2,\n      userBroadcastPush: 3,\n      userBroadcast: 4\n    };\n    this.BINARY_ENCODING = 0;\n    this.JSON_ENCODING = 1;\n    this.BROADCAST = 'broadcast';\n  }\n  encode(msg, callback) {\n    if (this._isArrayBuffer(msg.payload)) {\n      return callback(this._binaryEncodePush(msg));\n    }\n    if (msg.event === this.BROADCAST && !(msg.payload instanceof ArrayBuffer) && typeof msg.payload.event === 'string') {\n      return callback(this._binaryEncodeUserBroadcastPush(msg));\n    }\n    let payload = [msg.join_ref, msg.ref, msg.topic, msg.event, msg.payload];\n    return callback(JSON.stringify(payload));\n  }\n  _binaryEncodePush(message) {\n    const {\n      join_ref,\n      ref,\n      event,\n      topic,\n      payload\n    } = message;\n    const metaLength = this.META_LENGTH + join_ref.length + ref.length + topic.length + event.length;\n    const header = new ArrayBuffer(this.HEADER_LENGTH + metaLength);\n    let view = new DataView(header);\n    let offset = 0;\n    view.setUint8(offset++, this.KINDS.push); // kind\n    view.setUint8(offset++, join_ref.length);\n    view.setUint8(offset++, ref.length);\n    view.setUint8(offset++, topic.length);\n    view.setUint8(offset++, event.length);\n    Array.from(join_ref, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(ref, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(topic, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(event, char => view.setUint8(offset++, char.charCodeAt(0)));\n    var combined = new Uint8Array(header.byteLength + payload.byteLength);\n    combined.set(new Uint8Array(header), 0);\n    combined.set(new Uint8Array(payload), header.byteLength);\n    return combined.buffer;\n  }\n  _binaryEncodeUserBroadcastPush(message) {\n    var _a;\n    if (this._isArrayBuffer((_a = message.payload) === null || _a === void 0 ? void 0 : _a.payload)) {\n      return this._encodeBinaryUserBroadcastPush(message);\n    } else {\n      return this._encodeJsonUserBroadcastPush(message);\n    }\n  }\n  _encodeBinaryUserBroadcastPush(message) {\n    var _a, _b;\n    const {\n      join_ref,\n      ref,\n      topic\n    } = message;\n    const userEvent = message.payload.event;\n    const userPayload = (_b = (_a = message.payload) === null || _a === void 0 ? void 0 : _a.payload) !== null && _b !== void 0 ? _b : new ArrayBuffer(0);\n    const metaLength = this.USER_BROADCAST_PUSH_META_LENGTH + join_ref.length + ref.length + topic.length + userEvent.length;\n    const header = new ArrayBuffer(this.HEADER_LENGTH + metaLength);\n    let view = new DataView(header);\n    let offset = 0;\n    view.setUint8(offset++, this.KINDS.userBroadcastPush); // kind\n    view.setUint8(offset++, join_ref.length);\n    view.setUint8(offset++, ref.length);\n    view.setUint8(offset++, topic.length);\n    view.setUint8(offset++, userEvent.length);\n    view.setUint8(offset++, this.BINARY_ENCODING);\n    Array.from(join_ref, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(ref, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(topic, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(userEvent, char => view.setUint8(offset++, char.charCodeAt(0)));\n    var combined = new Uint8Array(header.byteLength + userPayload.byteLength);\n    combined.set(new Uint8Array(header), 0);\n    combined.set(new Uint8Array(userPayload), header.byteLength);\n    return combined.buffer;\n  }\n  _encodeJsonUserBroadcastPush(message) {\n    var _a, _b;\n    const {\n      join_ref,\n      ref,\n      topic\n    } = message;\n    const userEvent = message.payload.event;\n    const userPayload = (_b = (_a = message.payload) === null || _a === void 0 ? void 0 : _a.payload) !== null && _b !== void 0 ? _b : {};\n    const encoder = new TextEncoder(); // Encodes to UTF-8\n    const encodedUserPayload = encoder.encode(JSON.stringify(userPayload)).buffer;\n    const metaLength = this.USER_BROADCAST_PUSH_META_LENGTH + join_ref.length + ref.length + topic.length + userEvent.length;\n    const header = new ArrayBuffer(this.HEADER_LENGTH + metaLength);\n    let view = new DataView(header);\n    let offset = 0;\n    view.setUint8(offset++, this.KINDS.userBroadcastPush); // kind\n    view.setUint8(offset++, join_ref.length);\n    view.setUint8(offset++, ref.length);\n    view.setUint8(offset++, topic.length);\n    view.setUint8(offset++, userEvent.length);\n    view.setUint8(offset++, this.JSON_ENCODING);\n    Array.from(join_ref, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(ref, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(topic, char => view.setUint8(offset++, char.charCodeAt(0)));\n    Array.from(userEvent, char => view.setUint8(offset++, char.charCodeAt(0)));\n    var combined = new Uint8Array(header.byteLength + encodedUserPayload.byteLength);\n    combined.set(new Uint8Array(header), 0);\n    combined.set(new Uint8Array(encodedUserPayload), header.byteLength);\n    return combined.buffer;\n  }\n  decode(rawPayload, callback) {\n    if (this._isArrayBuffer(rawPayload)) {\n      let result = this._binaryDecode(rawPayload);\n      return callback(result);\n    }\n    if (typeof rawPayload === 'string') {\n      const jsonPayload = JSON.parse(rawPayload);\n      const [join_ref, ref, topic, event, payload] = jsonPayload;\n      return callback({\n        join_ref,\n        ref,\n        topic,\n        event,\n        payload\n      });\n    }\n    return callback({});\n  }\n  _binaryDecode(buffer) {\n    const view = new DataView(buffer);\n    const kind = view.getUint8(0);\n    const decoder = new TextDecoder();\n    switch (kind) {\n      case this.KINDS.push:\n        return this._decodePush(buffer, view, decoder);\n      case this.KINDS.reply:\n        return this._decodeReply(buffer, view, decoder);\n      case this.KINDS.broadcast:\n        return this._decodeBroadcast(buffer, view, decoder);\n      case this.KINDS.userBroadcast:\n        return this._decodeUserBroadcast(buffer, view, decoder);\n    }\n  }\n  _decodePush(buffer, view, decoder) {\n    const joinRefSize = view.getUint8(1);\n    const topicSize = view.getUint8(2);\n    const eventSize = view.getUint8(3);\n    let offset = this.HEADER_LENGTH + this.META_LENGTH - 1; // pushes have no ref\n    const joinRef = decoder.decode(buffer.slice(offset, offset + joinRefSize));\n    offset = offset + joinRefSize;\n    const topic = decoder.decode(buffer.slice(offset, offset + topicSize));\n    offset = offset + topicSize;\n    const event = decoder.decode(buffer.slice(offset, offset + eventSize));\n    offset = offset + eventSize;\n    const data = JSON.parse(decoder.decode(buffer.slice(offset, buffer.byteLength)));\n    return {\n      join_ref: joinRef,\n      ref: null,\n      topic: topic,\n      event: event,\n      payload: data\n    };\n  }\n  _decodeReply(buffer, view, decoder) {\n    const joinRefSize = view.getUint8(1);\n    const refSize = view.getUint8(2);\n    const topicSize = view.getUint8(3);\n    const eventSize = view.getUint8(4);\n    let offset = this.HEADER_LENGTH + this.META_LENGTH;\n    const joinRef = decoder.decode(buffer.slice(offset, offset + joinRefSize));\n    offset = offset + joinRefSize;\n    const ref = decoder.decode(buffer.slice(offset, offset + refSize));\n    offset = offset + refSize;\n    const topic = decoder.decode(buffer.slice(offset, offset + topicSize));\n    offset = offset + topicSize;\n    const event = decoder.decode(buffer.slice(offset, offset + eventSize));\n    offset = offset + eventSize;\n    const data = JSON.parse(decoder.decode(buffer.slice(offset, buffer.byteLength)));\n    const payload = {\n      status: event,\n      response: data\n    };\n    return {\n      join_ref: joinRef,\n      ref: ref,\n      topic: topic,\n      event: CHANNEL_EVENTS.reply,\n      payload: payload\n    };\n  }\n  _decodeBroadcast(buffer, view, decoder) {\n    const topicSize = view.getUint8(1);\n    const eventSize = view.getUint8(2);\n    let offset = this.HEADER_LENGTH + 2;\n    const topic = decoder.decode(buffer.slice(offset, offset + topicSize));\n    offset = offset + topicSize;\n    const event = decoder.decode(buffer.slice(offset, offset + eventSize));\n    offset = offset + eventSize;\n    const data = JSON.parse(decoder.decode(buffer.slice(offset, buffer.byteLength)));\n    return {\n      join_ref: null,\n      ref: null,\n      topic: topic,\n      event: event,\n      payload: data\n    };\n  }\n  _decodeUserBroadcast(buffer, view, decoder) {\n    const topicSize = view.getUint8(1);\n    const userEventSize = view.getUint8(2);\n    const metadataSize = view.getUint8(3);\n    const payloadEncoding = view.getUint8(4);\n    let offset = this.HEADER_LENGTH + 4;\n    const topic = decoder.decode(buffer.slice(offset, offset + topicSize));\n    offset = offset + topicSize;\n    const userEvent = decoder.decode(buffer.slice(offset, offset + userEventSize));\n    offset = offset + userEventSize;\n    const metadata = decoder.decode(buffer.slice(offset, offset + metadataSize));\n    offset = offset + metadataSize;\n    const payload = buffer.slice(offset, buffer.byteLength);\n    const parsedPayload = payloadEncoding === this.JSON_ENCODING ? JSON.parse(decoder.decode(payload)) : payload;\n    const data = {\n      type: this.BROADCAST,\n      event: userEvent,\n      payload: parsedPayload\n    };\n    // Metadata is optional and always JSON encoded\n    if (metadataSize > 0) {\n      data['meta'] = JSON.parse(metadata);\n    }\n    return {\n      join_ref: null,\n      ref: null,\n      topic: topic,\n      event: this.BROADCAST,\n      payload: data\n    };\n  }\n  _isArrayBuffer(buffer) {\n    var _a;\n    return buffer instanceof ArrayBuffer || ((_a = buffer === null || buffer === void 0 ? void 0 : buffer.constructor) === null || _a === void 0 ? void 0 : _a.name) === 'ArrayBuffer';\n  }\n}\n//# sourceMappingURL=serializer.js.map\nexport { Serializer as default };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}